<script type="text/javascript">
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const camera = document.getElementById('ar-camera');

  // Initialize jsfeat variables
  const img_u8 = new jsfeat.matrix_t(canvas.width, canvas.height, jsfeat.U8_t | jsfeat.C1_t);
  const corners = [];
  for (let i = 0; i < canvas.width * canvas.height; i++) {
    corners[i] = new jsfeat.keypoint_t(0, 0, 0, 0);
  }

  let lastX = 0, lastY = 0, lastZ = 0;
  const smoothingFactor = 0.1;
  const depthScale = 1;

  navigator.mediaDevices.getUserMedia({ 
    video: true
  })
  .then((stream) => {
    video.srcObject = stream;
    video.addEventListener('loadedmetadata', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      video.play();
    });
    video.addEventListener('play', () => {
      processVideo();
    });
  })
  .catch((error) => {
    console.error('Errore nell\'accesso alla fotocamera: ', error);
  });

  function detectFeatures() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    console.log('Larghezza canvas:', canvas.width, 'Altezza canvas:', canvas.height);
    console.log('Dati immagine (prime 100):', imageData.data.slice(0, 100));

    jsfeat.imgproc.grayscale(imageData.data, canvas.width, canvas.height, img_u8);
    jsfeat.imgproc.equalize_histogram(img_u8, img_u8); // Aumenta il contrasto

    jsfeat.yape06.laplacian_threshold = 20;  
    jsfeat.yape06.min_eigen_value_threshold = 10;  
    const count = jsfeat.yape06.detect(img_u8, corners, 500);

    console.log(`Numero di punti rilevati: ${count}`);
    if (count > 0) {
      const points = [];
      for (let i = 0; i < count; i++) {
        points.push({ x: corners[i].x, y: corners[i].y });
      }
      console.log('Punti rilevati:', points.map(p => `(${p.x}, ${p.y})`));
      return points;
    } else {
      console.log('Nessun punto rilevato.');
      return [];
    }
  }

  function estimateCameraPose(points) {
    if (points.length > 0) {
      const avgX = points.reduce((sum, p) => sum + p.x, 0) / points.length;
      const avgY = points.reduce((sum, p) => sum + p.y, 0) / points.length;
      const x3D = (avgX / canvas.width) * 10 - 5;
      const y3D = (avgY / canvas.height) * 10 - 5;
      const zEstimate = depthScale;

      const smoothedX = lastX * (1 - smoothingFactor) + x3D * smoothingFactor;
      const smoothedY = lastY * (1 - smoothingFactor) + y3D * smoothingFactor;
      const smoothedZ = lastZ * (1 - smoothingFactor) + zEstimate * smoothingFactor;

      camera.setAttribute('position', `${smoothedX} ${smoothedY} ${smoothedZ}`);
      console.log(`Posizione della camera aggiornata: X=${smoothedX}, Y=${smoothedY}, Z=${smoothedZ}`);
      
      lastX = smoothedX;
      lastY = smoothedY;
      lastZ = smoothedZ;
    } else {
      console.log("Nessun punto rilevato.");
    }
  }

  function processVideo() {
    const points = detectFeatures();
    estimateCameraPose(points);
    requestAnimationFrame(processVideo);
  }
</script>
